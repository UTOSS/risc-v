name: risc-v CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build_ci_image:
    uses: ./.github/workflows/docker-image.yml
    with:
      image-name: ghcr.io/utoss/risc-v
      dockerfile: ./Dockerfile.ci
      tag-prefix: ci-
    secrets: inherit

  build_devcontainer_image:
    uses: ./.github/workflows/docker-image.yml
    with:
      image-name: ghcr.io/utoss/risc-v-devcontainer
      dockerfile: .devcontainer/Dockerfile
      tag-prefix: ""
    secrets: inherit

  svlint:
    needs: build_ci_image
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build_ci_image.outputs.image-primary-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: lint sources
        run: make svlint

      - name: lint testbench
        run: make svlint_tb

      - name: lint DE1-SoC environment files
        run: make svlint ENV=de1-soc

  build_and_test:
    timeout-minutes: 30
    needs: build_ci_image
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build_ci_image.outputs.image-primary-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build top
        id: build-top
        run: make build_top

      - name: Build testbench
        id: build-testbench
        run: make build_tb

      - name: Run testbench
        run: make run_tb

      - name: Upload VCD files
        uses: actions/upload-artifact@v4
        if: steps.build-testbench.outcome == 'success'
        with:
          name: vcd-files
          path: test/vcd/*.vcd
          retention-days: 7

      - name: Upload VVP files
        uses: actions/upload-artifact@v4
        if: steps.build-top.outcome == 'success'
        with:
          name: vvp-files
          path: out/*.vvp
          retention-days: 7

  riscof:
    timeout-minutes: 30
    needs: build_ci_image
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build_ci_image.outputs.image-primary-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build DUT
        run: make riscof_build_dut

      - name: Validate YAML
        run: make riscof_validateyaml

      - name: Clone arch-test
        run: make riscof_clone_archtest

      - name: Run RISCOF
        run: make riscof_run

      - name: Upload RISCOF report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: riscof-report
          path: |
            riscof/riscof_work/report.html
            riscof/riscof_work/style.css
          retention-days: 7

  de1-soc:
    timeout-minutes: 30
    needs:
      - build_ci_image
      - build_and_test
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build_ci_image.outputs.image-primary-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build PoC
        id: build-poc
        run: cd envs/de1-soc/poc && make

      - name: Build and run DE1-SoC testbench
        run: cd envs/de1-soc && make

      - name: Synthesize
        id: synthesize
        run: cd envs/de1-soc && make synthesize

      - name: Upload VCD file
        uses: actions/upload-artifact@v4
        if: steps.build-poc.outcome == 'success'
        with:
          name: de1-soc-tb-vcd
          path: envs/de1-soc/top_tb.vcd
          retention-days: 7

      - name: Upload SOF
        uses: actions/upload-artifact@v4
        if: steps.synthesize.outcome == 'success'
        with:
          name: de1-soc-sof
          path: envs/de1-soc/quartus/output_files/utoss-risc-v.sof

      - name: Upload Quartus reports
        uses: actions/upload-artifact@v4
        if: steps.synthesize.outcome == 'success'
        with:
          name: de1-soc-quartus-reports
          path: |
            envs/de1-soc/quartus/output_files/utoss-risc-v.sta.summary
            envs/de1-soc/quartus/output_files/utoss-risc-v.fit.summary
          retention-days: 7

  fpga_metrics_comment:
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    needs: de1-soc
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download PR Quartus reports
        uses: actions/download-artifact@v4
        with:
          name: de1-soc-quartus-reports
          path: pr-reports

      - name: Download main branch Quartus reports
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        id: download-main
        with:
          workflow: ci.yaml
          branch: main
          name: de1-soc-quartus-reports
          path: main-reports
          check_artifacts: true
          search_artifacts: true

      - name: Compare FPGA metrics
        id: compare
        run: |
          # Debug: Show what files we have
          echo "=== PR reports directory ==="
          ls -la pr-reports/ || echo "PR reports directory not found"
          
          echo "=== Main reports directory ==="
          ls -la main-reports/ || echo "Main reports directory not found"
          
          # Check if main branch reports exist
          if [ -f "main-reports/utoss-risc-v.fit.summary" ]; then
            BASE_FIT="main-reports/utoss-risc-v.fit.summary"
            echo "Found main branch .fit.summary"
          else
            BASE_FIT="none"
            echo "No main branch .fit.summary found"
          fi
          
          if [ -f "main-reports/utoss-risc-v.sta.summary" ]; then
            BASE_STA="main-reports/utoss-risc-v.sta.summary"
            echo "Found main branch .sta.summary"
          else
            BASE_STA="none"
            echo "No main branch .sta.summary found"
          fi
          
          # PR reports should always exist
          PR_FIT="pr-reports/utoss-risc-v.fit.summary"
          PR_STA="pr-reports/utoss-risc-v.sta.summary"
          
          # Check if PR reports exist
          if [ ! -f "$PR_FIT" ]; then
            echo "ERROR: PR .fit.summary not found at $PR_FIT"
          else
            echo "Found PR .fit.summary"
            echo "First 20 lines of PR .fit.summary:"
            head -20 "$PR_FIT"
          fi
          
          if [ ! -f "$PR_STA" ]; then
            echo "ERROR: PR .sta.summary not found at $PR_STA"
          else
            echo "Found PR .sta.summary"
            echo "First 20 lines of PR .sta.summary:"
            head -20 "$PR_STA"
          fi
          
          # Run comparison script
          python3 .github/scripts/compare_fpga_metrics.py "$BASE_FIT" "$PR_FIT" "$BASE_STA" "$PR_STA" > comparison.md
          
          echo "=== Generated comparison report ==="
          cat comparison.md
          
          # Output for next step
          echo "COMPARISON_FILE=comparison.md" >> $GITHUB_OUTPUT

      - name: Post comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ”§ FPGA Resource Usage and Timing Report')
            );
            
            const commentBody = comparison;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
